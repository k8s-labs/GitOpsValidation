# GitOps Validation (gov)

This document contains the requirements to generate a PRD for the GitOps Validation (gov) application

- I wrote this file
  - It only took a few minutes as I could use a "stream of conciousness" approach instead of trying to organize
- `create-prd.mdc` is reused and contains the rules for generating a PRD
- `tasks/prd-gov.md` was generated by GitHub Agent Mode using GPT4.1

## Purpose

- gov validates that a set of Flux GitOps manifests are deployed correctly
- gov is usually deployed on the Kubernetes cluster that it is validating as a K8s deployment / pod
- gov is written in Go using standard go best practices and security
- gov is deployed by Kustomize
- gov should use K8s best practices for startup, healtchecks, shutdown, logging, etc
- gov should use json structured logging for Information, Warning, Error, and Fatal

## Parameters

- gov parameters can be environment variables or command line options - command line takes precedence, followed by environment variable, followed by default value
- an example parameter is the GitOps repo (usually an https url) to use. the env var should be GOV_REPO and the command line should be --gov-repo or -r; this param is required and does not have a default
- user ID for the repo - default "gitops"
- PAT for the repo - no default, not required for public repos
- branch for the repo - default "main"
- Path within the repo - default "./"
- wait time (in seconds) - time to wait between validations - default 60

## Application Flow

- gov starts and logs a starting message
- gov validates the parameters
  - gov logs any error messages and exits with a value of 1
- gov clones the repo using the repo, user, and PAT values
  - if the repo directory already exists, gov verifies the repo matches the repo parameter and proceeds
  - otherwise, gov logs an error and exit(1)
- gov checks out the branch - log and exit(1) on error
- gov uses git pull to pull the latest branch
- gov validates and changes to the path param directory (log and exit on error)
- gov validates that the namespaces, services, deployments, and pods specified in the GitOps Repo are deployed and running as specified on the K8s cluster
  - gov logs information messages for each valid deployment
  - gov logs warning messages for any namespace, service, or pod that is on the cluster but not in the GitOps Repo
- gov sleeps for wait time seconds and then repeats the git pull and validation until stopped
